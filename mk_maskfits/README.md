# mk_maskfits

## 目的

ds9 で作成した Region ファイルから、FITS 形式のマスク画像を作るためのノートブックです。  
マスクする場所を 1 の数値で埋め、それ以外は 0 の数値を埋めた画像が生成されます。  
ノートブックには僕の環境で実行した場合の結果を表示しています。  
<br>


## 事前準備
1. 書き換えの必要な場所  
    **Parameters** 以下のセルにある Dict_* 変数を書き換える必要があります。  
    ご自身の PC の環境/希望する設定に応じて書き換えてください。  
    必要に応じて、ディレクトリの作成などもここで行ってください。  
    また、**Operation Command** の MacroMF_hsc / MacroMF_others 関数もチェックが必要です。  
    calexp/maskreg/edgereg/excereg 変数の中身が適切かチェックしてください。  

2. ファイル  
    マスクする場所を定義した Region （以降 Reg） ファイルを用意し、Dict_SetGL.workdir に  
    記載したディレクトリに Reg ファイルを配置してください。  
    3 種類の Reg ファイル (maskreg/edgereg/excereg) を入力として与えることができます。  
    入力ファイルが見つからなかった場合は、その工程はスキップされます。  
    各 Reg ファイルの詳細については、次の項目をご覧ください。
    
3. ソフトウェア / モジュール  
    このノートブックでは Pillow (PIL) と astropy というソフトウェアが必要になっています。  
    **Modules** 以下のセルを実行した時にエラーが出ないことを確認してください。
<br>


## Region ファイル
*maskreg* にはマスクする場所を定義した Reg ファイルを与えます。  
Reg の **形通りに** マスク (1埋め) した FITS 画像が生成されます。  
Reg の形は 円/四角/楕円 が有効で、楕円のみ位置角 (Posision angle) に対応しています。  

*edgereg* には視野の端を定義した Reg ファイルを与えます。  
Reg で与えた **座標に沿って** 端を定義し、内側は 0 埋め、外側は1 埋めがなされます。  
Reg の形は 円 のみ有効ですが、Reg の形自体は無視されます (座標のみ読み込みます)。  
内側/外側の定義が必要で、デフォルトでは tract 中心を内側と定義しています。  
別の座標を中心としたい場合、MacroMF_others 関数内にある center_edge 変数を  
書き換えてください （image 座標で与えて下さい）。  
MacroMF_hsc 関数では中心を変更できないので、もし変更が必要な場合は MacroMF_others  
関数のように center_edge 変数を与えてください。  

*excereg* にはマスクしない場所を定義した Reg ファイルを与えます。  
maskreg と同様に、Reg の **形通りに** マスクしない領域 (0埋め) として FITS 画像が生成されます。  
もし maskreg と重なる部分があった場合、excereg の方が優先されます。  
例外的にマスクをしたくない場所がある場合に用意してください。  

テスト用に、patch=404 と 408 に対して使用できる maskreg / edgereg ファイルを用意しています  
(それぞれ maskreg_wcs.reg と edgereg_wcs.reg というファイル名で保存されています)。  
HSC-SSP PDR2 の Web ページから適当なフィルターの tract=9813, patch=4,4 と 4,8 のデータを  
ダウンロードしてくることで、これらファイルを使ったテストが可能です。  
<br>


## 出力されるもの
最後まで実行されると、Dict_SetGL.workdir 内に表に記載されたようなファイルが生成されます。  
(一例として, filter=NB0527, tract=9813, patch=404 の結果を表示しています)   


|生成ファイル|説明|
|:--|:--|
|Mask-NB0527_t9813p404_1.fits|サイエンス画像と同じサイズ、同じ wcs 座標が定義されたマスク画像|

<br>


## 注意点
1. 撮像データ  
    すばる望遠鏡の Hyper Suprime-Cam で観測された撮像データに適用することを想定しています。  
    このため、サイエンス画像の名前は以下でないとそのまま実行できません。
    > サイエンス画像 : calexp-[FILTER]-[TRACT]-[patch_x],[patch_y].fits  

    これは **Operation command** にある MacroMF_hsc 関数の calexp 変数の中身を  
    適宜書き換えることで調整できます。  
    
    また、FITS 画像の HDU 番号も適切に指定する必要があります。  
    FITS フォーマットは 1 つのヘッダ + 1 つのデータで Header Data Unit (HDU) を定義します。  
    HDU は 1 つの FITS データに複数格納することができ、これを指定するのが HDU 番号です。  
    > 複数のものは Multi-Extension FITS image と呼ぶようです。  
    > データ部には画像以外にも、カタログデータなどを入れることも可能です。  
    > 例えば HSC の場合 HDU が複数入っていて、HDU=1 がサイエンス画像です。  
    > HDU=2 以降にもデータがあります。
    
2. 用意する Region ファイルについて    
    Region ファイルは wcs 座標の degree の単位で保存をしてください。  
    hhmmss+ddmmss のような六十進法 (sexagesimal) で保存すると実行に失敗します。  
<br>


## このノートのデフォルト設定

- 画像のピクセルスケール  
    0.168 arcsec/pix  

- Region ファイルのヘッダ部分の行数  
    3  
