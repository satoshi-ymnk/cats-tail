# meas_limitmag

## 目的

画像の限界等級を測るためのノートブックです。  
ランダムなスカイポジションに対してアパーチャー測光した結果から限界等級を推定します。  
ノートブックには僕の環境で実行した場合 の結果を表示しています。  
<br>


## 事前準備
1. 書き換えの必要な場所  
    **Parameters** 以下のセルにある Dict_* 変数を書き換える必要があります。  
    ご自身の PC の環境/希望する設定に応じて書き換えてください。  
    必要に応じて、ディレクトリの作成などもここで行ってください。  
    また、**Operation Command** の MacroLM_hsc / MacroLM_others 関数もチェックが必要です。  
    calexp/combmask 変数の中身が適切かチェックしてください。  

2. ファイル  
    このフォルダにある limit.sex と limit.param を **Parameters** の Dict_SetGL.workdir で与えた  
    ディレクトリにコピーしてください。検出に関係するパラメーターは全てノートブック側で  
    上書きをしますが、その他のパラメーターはこの limit.sex を読み込みます。  
    limit.param は SExtractor で何を測定するか記述しています。  
    HSC の画像を使う限りは、どちらもコピーするだけで大丈夫です。  

3. ソフトウェア / モジュール  
    このノートブックでは [SExtractor](https://github.com/astromatic/sextractor) を使用します。動作することを確認してください。  
    また、astropy/photutils というソフトウェアも必要になっています。  
    **Modules** 以下のセルを実行した時にエラーが出ないことを確認してください。
    
<br>


## 出力されるもの
最後まで実行されると、Dict_SetGL.workdir 内に表に記載されたようなファイルが生成されます (一例として, filter=NB0527, tract=9813, patch=404 の結果を表示しています)。  
測定結果として org,med,ave というものが出てきます。これはローカルスカイを 引かなかった場合, 中央値を使って引いた場合, 平均値を使って引いた場合の結果を示しています。  


|生成ファイル|説明|
|:--|:--|
|limit_tmp.fits|サイエンス画像を SExtractor で読みこめるように変換したファイル (single-extension FITS 画像に変換)|
|limit_wei.fits|マスク画像を SExtractor で読みこめるように変換したファイル (single-extension FITS 画像に変換)|
|limit.cat|SExtractor で作成した検出天体カタログ (解析には使いません)|
|limit_seg.fits|SExtractor で作成した検出天体の Segmentation 画像 (天体の場所を避けるために使います)|
|skylis_NB0527_t9813p404.1.reg|ランダムスカイアパーチャーの座標について ds9 で閲覧可能な region ファイル|
|astrphot_NB0527_t9813p404.1.txt|全ての測光結果をまとめたファイル|
|astrphot_NB0527_t9813p404.1sub.txt|測光結果ファイルからヒストグラムを描くために必要な情報だけ取り出したファイル|
|resfit_NB0527_t9813p404.1org.png|ヒストグラムに対してフィッティングを行った結果の図 (ローカルスカイ引きをしなかった結果)|
|resfit_NB0527_t9813p404.1med.png|ヒストグラムに対してフィッティングを行った結果の図 (ローカルスカイを中央値で引いた結果)|
|resfit_NB0527_t9813p404.1ave.png|ヒストグラムに対してフィッティングを行った結果の図 (ローカルスカイを平均値で引いた結果)|
|res_limmag_NB0527_t9813p404.1.txt|最終的な結果を全て記載したファイル|

<br>


## 注意点
1. 撮像データ  
    すばる望遠鏡の Hyper Suprime-Cam で観測された撮像データに適用することを想定しています。  
    また、マスク画像も自分で作成したものを想定しています。  
    このため、サイエンス画像/マスク画像の名前は以下でないとそのまま実行できません。
    > サイエンス画像 : calexp-[FILTER]-[TRACT]-[patch_x],[patch_y].fits  
    > マスク画像 : CombMask_[FILTER]\_t[TRACT]p[patch_x]0[patch_y].fits

    これは **Operation command** にある MacroLM 関数の calexp/combmask 変数の中身を  
    適宜書き換えることで調整できます。マスク画像は作成していなくても実行は可能です。
    
    また、FITS 画像の HDU 番号も適切に指定する必要があります。  
    FITS フォーマットは 1 つのヘッダ + 1 つのデータで Header Data Unit (HDU) を定義します。  
    HDU は 1 つの FITS データに複数格納することができ、これを指定するのが HDU 番号です。  
    > 複数のものは Multi-Extension FITS image と呼ぶようです。  
    > データ部には画像以外にも、カタログデータなどを入れることも可能です。  
    > 例えば HSC の場合 HDU が複数入っていて、HDU=1 がサイエンス画像です。  
    > HDU=2 以降にもデータがあります。
    
2. astropy/photutils のバージョンについて  
    インストールされている astropy/photutils のバージョンによっては警告やエラーをはくことが  
    あります。基本的には、関数の引数の名前が変更されている、などが原因です。  
    自作関数である AstropyPhot_imgcoo2 内のコメントアウトしているコマンドに変更すると  
    上手くいく場合があります (古いコマンドは適宜コメントアウトしてください)。
<br>


## このノートのデフォルト設定

- 画像のピクセルスケール  
    0.168 arcsec/pix  

- 限界等級を計算する際のアパーチャーサイズ  
    phi = 2.0 arcsec / 半径 r ~ 5.95pix  

- 用意するアパーチャーの数  
    10000

- 測光時のローカルスカイ推定に関する設定  
    スカイ推定に用いる円環の内半径  =  5.95pix + 3.0pix  
    スカイ推定に用いる円環の外半径  =  5.95pix + 3.0pix + 5.95pix
